SELECT
    B.OFFENDER,
    B.PPN,
    B.FACILITY,
    ISNULL(CL.CLASSIFICATION, 'UNKNOWN') AS [CLASSIFICATION],
    B.RACE,
    B.SEX AS [GENDER],
    FORMAT(B.DOB, 'MM-dd-yyyy') AS [BIRTHDATE],
    DATEDIFF(YEAR, B.DOB, GETDATE()) - 
        CASE 
            WHEN MONTH(B.DOB) > MONTH(GETDATE()) 
                OR (MONTH(B.DOB) = MONTH(GETDATE()) AND DAY(B.DOB) > DAY(GETDATE())) 
            THEN 1 
            ELSE 0 
        END AS [AGE],
    B.LNAME AS [LAST NAME],
    B.RNAME AS [FIRST NAME],
    SUM(B.BAIL) AS [TOTAL BAIL]
FROM 
    V_BAILVIEW B
LEFT JOIN 
    REP_DETAINERS DET ON B.OFFENDER = DET.OFFENDER
LEFT JOIN
    REP_CLASSIFICATION CL ON B.OFFENDER = CL.OFFENDER
    AND CL.EVALUATED = (
            SELECT MAX(CL_SUB.EVALUATED)
            FROM REP_CLASSIFICATION CL_SUB
            WHERE CL_SUB.OFFENDER = CL.OFFENDER)
WHERE
    NOT EXISTS (
        SELECT 1 
        FROM V_BAILVIEW B2 
        WHERE B2.OFFENDER = B.OFFENDER 
        AND B2.BAIL IS NULL
    )
    AND NOT EXISTS (
        SELECT 1 
        FROM REP_DETAINERS DET2
        WHERE DET2.OFFENDER = B.OFFENDER
        AND DET2.RELEASED IS NULL
    )
GROUP BY 
    B.OFFENDER,
    B.PPN,
    B.FACILITY,
    ISNULL(CL.CLASSIFICATION, 'UNKNOWN'),
    B.RACE,
    B.SEX,
    B.DOB,
    B.LNAME,
    B.RNAME

--HAVING SUM(B.BAIL) <= 50000 
ORDER BY
    B.LNAME,
    B.RNAME;
